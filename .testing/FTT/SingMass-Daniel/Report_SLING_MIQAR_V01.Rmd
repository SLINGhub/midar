---
title: "Daniel"
author: "SingMass / 03 March 2023"
subtitle: Lipidomics Analysis Report V1.2
output:
  powerpoint_presentation: 
    reference_doc: SingMass_report_template.pptx
    toc: yes
  slidy_presentation: default
  beamer_presentation: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
devtools::load_all()
library(tidyverse)
library(here)
library(cowplot)
library(readxl)
```

```{r data-import}
d_orig <- read_xlsx(here(".testing/FTT/SingMass-Daniel/data/20230116-FFP-Daniel-Quantification_V20220303.xlsx"), 
                    sheet = "Clean quantification", 
                    trim_ws = TRUE)

d_metadata <- read_xlsx(here(".testing/FTT/SingMass-Daniel/data/20230116-FFP-Daniel-Quantification_V20220301.xlsx"), 
                    sheet = "Sample Metadata", 
                    trim_ws = TRUE) 

d_long <- d_orig |> 
  rename(FEATURE_NAME = Name) |> 
  filter(!is.na(FEATURE_NAME)) |>  # Remove rows with other info (protein conc etc)
  select(-`Precursor Ion`, -`Product Ion`, -RT) |> 
  pivot_longer(-FEATURE_NAME, names_to = "ANALYSIS_ID", values_to = "Concentration") |> 
  filter(!str_detect(FEATURE_NAME, "IS"))

annot_colors <- list(
  ExpGroup = c("CTRL" = "cyan3", "BaP 1uM" = "darkred", "BaP 2uM" = "red")
)

```


# EXPLORATORY DATA ANALYSIS

## Sample Clustering
**Figure 1.** Heatmap with clusering of samples and lipid species

```{r heatmap, dpi = 300}

annot_colors <- list(
  ExpGroup = c("CTRL" = "cyan3", "BaP 1uM" = "darkred", "BaP 2uM" = "red")
)


p_hm <- plot_heatmap(data = d_long, d_metadata = d_metadata |>  select(ANALYSIS_ID = SAMPLE_ID, ExpGroup), 
                     annot_color = annot_colors, log_transform = FALSE, split_variable = NULL, 
                     clust_rows = FALSE, clust_columns = TRUE,row_names_size = 4, col_names_size = 7) 

draw(p_hm)

```

## PCA analysis

**Figure 2.** Principal component analysis of all samples based on all lipid species. Ellipses are solely meant for annotation of the groups. 
  
```{r pca, dpi=300}
p_pca <- plot_pca_sling2(data = d_long, d_metadata = d_metadata |>  select(ANALYSIS_ID = SAMPLE_ID, ExpGroup), log_transform = FALSE, dim_x = 1, dim_y = 2, grouping = "ExpGroup", annot_color = annot_colors$ExpGroup, point_size = 3, fill_alpha = 0.05, ellipse = TRUE, mark_ellipse = TRUE) 
p_pca

```

## Statistical Comparisons

**Figure 3.** Volcano plots from the statistical comparison of the experimental groups using Welch's *t*-tests. Lipid species with significant differences between the groups are highlighted in red (*P* \< 0.05 and \|FC\| \> 1.1).

```{r volcano, fig.height=4, fig.width=6, dpi=300}
d_datannot <- d_long |> left_join(d_metadata, by = c("ANALYSIS_ID"="SAMPLE_ID"))


d_stats1 <- get_stats(d_datannot, feature = "FEATURE_NAME", grouping = "ExpGroup", group_case = "BaP 1uM", group_ref = "CTRL", paired = FALSE)
p_volcano1 <- volcano_plot(d_FC = d_stats1, p_adjust = FALSE, sig_FC_min = 1.1, sig_p_value_min = 0.05, symmetric_x = TRUE, point_size = 1, point_transparency = 0.5, scale_factor = 1, scale_factor_species_label = .5, axistick = 1)

d_stats2 <- get_stats(d_datannot, feature = "FEATURE_NAME", grouping = "ExpGroup", group_case = "BaP 2uM", group_ref = "CTRL", paired = FALSE)
p_volcano2 <- volcano_plot(d_FC = d_stats2, p_adjust = FALSE, sig_FC_min = 1.1, sig_p_value_min = 0.05, symmetric_x = TRUE, point_size = 1, point_transparency = 0.5, scale_factor = 1, scale_factor_species_label = .5, axistick = 1)

p_fig1 <- cowplot::plot_grid(p_volcano1 + ggtitle("1 \U003BCmol/L BaP vs CTRL"), p_volcano2+ ggtitle(" 2 \U003BCmol/L BaP vs CTRL"))

p_fig1

```

## Significanlty different lipid species

**Figure 4.** Lipid species with statistically significant changes as indicated in the Figure 3 (*P* \> 0.5, \|FC\| \> 1.1) 

```{r dot2, fig.height=4, fig.width=6,  message=FALSE, warning=FALSE, dpi=300}
#devtools::load_all()

d_sign1 <- d_stats1 |> filter(p_value < 0.05, abs(log2FC) > log2(1.1)) |> select(FEATURE_NAME)
d_sign2 <- d_stats2 |> filter(p_value < 0.05, abs(log2FC) > log2(1.1)) |> select(FEATURE_NAME)
d_long_sign <- d_long |> inner_join(bind_rows(d_sign1, d_sign2)) 

d_metadata$ExpGroup <- forcats::fct_relevel(d_metadata$ExpGroup, c("CTRL", "BaP 1uM", "BaP 2uM"))

pp <- plot_dotboxplus(data = d_long_sign, d_metadata = d_metadata, inner_group = ExpGroup, outer_group = Exp, 
                contrasts = list(c("BaP 1uM", "CTRL"), c("BaP 2uM", "CTRL"), c("BaP 2uM", "BaP 1uM")),
                inner_group_colors = annot_colors$ExpGroup, 
                rows_page = 2, columns_page = 6, class_per_page = FALSE, save_pdf = FALSE, filename = "dotplots2sigf_V12.pdf", paired = FALSE, scale_text =.5, scale_signf = 2.0) 
print(pp)
```

## Dot/box plots of all species

**Figure 5.** All species quantified and passing QC

```{r dot, fig.height=4, fig.width=6,  message=FALSE, warning=FALSE, dpi=300}

d_metadata$ExpGroup <- forcats::fct_relevel(d_metadata$ExpGroup, c("CTRL", "BaP 1uM", "BaP 2uM"))

pp <- plot_dotboxplus(data = d_long, d_metadata = d_metadata, inner_group = ExpGroup, outer_group = Exp, 
                contrasts = list(c("BaP 1uM", "CTRL"), c("BaP 2uM", "CTRL"), c("BaP 2uM", "BaP 1uM")),
                inner_group_colors = annot_colors$ExpGroup, 
                rows_page = 3, columns_page = 6, class_per_page = FALSE, save_pdf = FALSE, filename = "dotplots2sigf_V12.pdf", paired = FALSE, scale_text =.7, scale_signf = 2.5) 
print(pp)
```



---
title: "Endofotonics"
author: "SingMass / 12 March 2023"
subtitle: Lipidomics Analysis Report V1.2
output:
  powerpoint_presentation: 
    reference_doc: SingMass_report_template.pptx
    toc: yes
  slidy_presentation: default
  beamer_presentation: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
devtools::load_all()

library(tidyverse)
library(here)
library(cowplot)
library(readxl)
library(patchwork)
```

```{r data-import}
d_orig <- read_xlsx(here(".testing/FTT/SingMass-Endofotonics/data/Tissue_Endofotonics_Report 20230114.xlsx"), 
                    sheet = "FinalResults CSV", 
                    trim_ws = TRUE)

d_metadata <- read_xlsx(here(".testing/FTT/SingMass-Endofotonics/data/SNUH samples Info.xlsx"), 
                    sheet = "SampleInfo Curated (BB)", 
                    trim_ws = TRUE) |> 
  filter(ExpGroup != "EFX")

d_long <- d_orig |> 
  rename(FEATURE_NAME = Name) |> 
  filter(!is.na(FEATURE_NAME)) |>  # Remove rows with other info (protein conc etc)
  pivot_longer(-FEATURE_NAME, names_to = "ANALYSIS_ID", values_to = "Concentration") |> 
  filter(!str_detect(FEATURE_NAME, "IS")) 

annot_colors <- list(
  ExpGroup = c("EF0" = "cyan3", "EF1" = "red")
)


```


# EXPLORATORY DATA ANALYSIS

## Sample Clustering
**Figure 1.** Heatmap with clustering of samples. Dendrogram is based on hierarchical clustering of Euclidean distances of z-scored lipid concentrations using complete linkage. Lipid species were ordered by alphabetical order. For the heatmap, colors corresponds to z-scored (per row) concentration values.

```{r heatmap, dpi = 900, fig.height=7, fig.width=8}

p_hm <- plot_heatmap(data = d_long, d_metadata = d_metadata |>  select(ANALYSIS_ID = SAMPLE_ID, ExpGroup), 
                     annot_color = annot_colors, log_transform = FALSE, split_variable = NULL, 
                       clust_rows = FALSE, clust_columns = TRUE,row_names_size = 1, col_names_size = 6) 

pdf(file = "heatmap2.pdf")
draw(p_hm)
dev.off()

```

## PCA analysis

**Figure 2.** Principal component analysis (PCA) of all samples based on all lipid species. PCA is based on standardized and centered (z-scored) concentration data of all measured lipid species and samples. Shaded ellipses are correspond to 95% confidence ranges for each group. 

  
```{r pca, dpi=300, fig.height=4, fig.width=8}
p_pca1 <- plot_pca_sling2(data = d_long, d_metadata = d_metadata |>  select(ANALYSIS_ID = SAMPLE_ID, ExpGroup), log_transform = FALSE, dim_x = 1, dim_y = 2, grouping = "ExpGroup", annot_color = annot_colors$ExpGroup, point_size = 3, fill_alpha = 0.05, ellipse = TRUE, mark_ellipse = FALSE, show_labels = TRUE, label_size = 2) 

p_pca2 <- plot_pca_sling2(data = d_long, d_metadata = d_metadata |>  select(ANALYSIS_ID = SAMPLE_ID, ExpGroup), log_transform = FALSE, dim_x = 3, dim_y = 4, grouping = "ExpGroup", annot_color = annot_colors$ExpGroup, point_size = 3, fill_alpha = 0.05, ellipse = TRUE, mark_ellipse = FALSE, show_labels = TRUE, label_size = 2) 


p_pca <- p_pca1 + theme(legend.position = "none")+ p_pca2
p_pca
```

## Statistical Comparisons

**Figure 3.** Volcano plots obtained from the statistical comparison of the experimental groups. Unadjusted P values were obtained from paired t-tests using lipid concentrations. Log2FC corresponds to the log2 of the fold-changes between the group means of the EF1 and EF0 experimental groups. Positive log2FC indicates concentrations are higher in the EF1 group compared to the reference group (EF0). Lipid species with P < 0.05  and |FC| > 1.5 ( = |log2FC| > 0.585) are highlighted in red.

```{r volcano, fig.height=4, fig.width=6, dpi=300}
d_datannot <- d_long |> left_join(d_metadata, by = c("ANALYSIS_ID"="SAMPLE_ID"))


d_stats1 <- get_stats(d_datannot, feature = "FEATURE_NAME", grouping = "ExpGroup", group_case = "EF1", group_ref = "EF0", paired = TRUE)
p_volcano1 <- volcano_plot(d_FC = d_stats1, p_adjust = FALSE, sig_FC_min = 1.5, sig_p_value_min = 0.05, symmetric_x = TRUE, point_size = 1, point_transparency = 0.5, scale_factor = 1, scale_factor_species_label = .5, axistick = 1)

p_volcano1
write_csv(x = d_stats1, file = "stats.csv")

```

## Significanlty different lipid species

**Figure 4.** Lipid species with statistically significant changes as highlighted in Figure 3. Only lipid species with P < 0.05 and |FC| > 1.5 from the comparisons EF1 vs EF0. Statistical significances correspond to the results of paired t-tests on concentration data. Only significant comparisons (P < 0.05) indicated:  * < 0.05, ** < 0.01, *** < 0.001. Concentration corresponds to pmol/mg protein.


```{r dot2, fig.height=6, fig.width=10,  message=FALSE, warning=FALSE, dpi=300}
#devtools::load_all()

d_sign1 <- d_stats1 |> filter(p_value < 0.05, abs(log2FC) > log2(1.5)) |> select(FEATURE_NAME)
d_long_sign <- d_long |> inner_join(d_sign1) 

d_metadata$ExpGroup <- forcats::fct_relevel(d_metadata$ExpGroup, c("EF0", "EF1"))
d_metadata$SUBJECT_ID <- factor(d_metadata$StudyNo)
pp <- plot_dotboxplus(data = d_long_sign, d_metadata = d_metadata, inner_group = ExpGroup, outer_group = Exp, 
                contrasts = list(c("EF1", "EF0")),
                inner_group_colors = annot_colors$ExpGroup, 
                rows_page = 5, columns_page = 8, class_per_page = FALSE, save_pdf = FALSE, filename = "dotplots2sigf_V12.pdf", paired = TRUE, scale_text =.6, scale_signf = 2, point_size = 1) 
print(pp)
```

## Dot/box plots of all species

**Figure 5.** Dot and box plots of all quantified lipid species. Statistical significances correspond to the result of paired t-test on concentration data. Only significant comparisons (P < 0.05) indicated:  * < 0.05, ** < 0.01, *** < 0.001. Concentration corresponds to pmol/mg protein.

```{r dot, fig.height=6, fig.width=10,  message=FALSE, warning=FALSE, dpi=300}

d_metadata$ExpGroup <- forcats::fct_relevel(d_metadata$ExpGroup, c("EF0", "EF1"))
d_metadata$SUBJECT_ID <- factor(d_metadata$StudyNo)

pp <- plot_dotboxplus(data = d_long, d_metadata = d_metadata, inner_group = ExpGroup, outer_group = Exp, 
                contrasts = list(c("EF1", "EF0")),
                inner_group_colors = annot_colors$ExpGroup, 
                rows_page = 5, columns_page = 8, class_per_page = FALSE, save_pdf = FALSE, filename = "dotplots2sigf_V12.pdf", paired = TRUE, scale_text =.6, scale_signf = 1.5, point_size = 1) 
print(pp)
```



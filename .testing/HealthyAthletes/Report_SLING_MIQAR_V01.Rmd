---
title: Healthy Athletes
subtitle: Lipidomics Analysis Report V1.1
author: SLING / 03 March 2023
output:
  powerpoint_presentation:
    reference_doc: SLING_report_template.pptx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
devtools::load_all()
library(tidyverse)
library(here)
library(cowplot)
mexp3 <- readRDS(here(".testing/HealthyAthletes/output", paste0("P20036_HealthyAthletes_Baker2_MiQARreport.rds")))
```

# QUALITY CONTROL

## QC and Sample Variability and Outliers

**Figure 1: PCA of all QCs and samples** BQCs (Batch QCs) are pooled samples co-extracted with samples that represent the sample preparation and MS analysis variability. The TQC (technical QCs) is a common sample measured at regular intervals to monitor the instrument stability. Ideally, the BQC should be centered closely in the middle. No appearednt outliers. **PASSED.**

```{r s2, warning = FALSE, message = FALSE}
plot_pca_sling(mexp3,variable = "CONC_FINAL", log_transform = TRUE, dim_x = 1, dim_y = 2, grouping = TRUE, fill_alpha = .1)
```

## Analytical Robustness

**Figure 2:** Concentrations of selected species in QC and study sample arranged by analysis order. No appearent batch effects and drifts, QC samples with low variability and centered in the middle. **Passed**

```{r ISTD, fig.height=3, fig.width=5, message=FALSE, warning=FALSE, dpi=300}
p <- plot_runscatter(
  data = mexp3,
  y_var = "CONC_FINAL", 
  cap_values = TRUE,
  cap_top_n = 20,
  cap_SPL_SD =3 ,
  cap_QC_SD = 3,
  QC_TYPE_fit = "BQC", 
  transition_filter = "CAR 18:1|PC 34:1|PC 38:4(b)|PI 38:3(a)|PC 38:6(b)|S1P d18:1$|CE 16:0|CE 20:4|^Cer d18:1/24:0|^Cer d18:1/16:0|LPC 16:1 (b)|PE 34:1|PS 38:4|TG 50:4 \\[-",
  filter_exclude = FALSE,
  show_driftcorrection = FALSE,
  after_correction = FALSE, 
  show_batches = TRUE,
  batches_as_shades = FALSE,
  batch_line_color = "bisque2"  ,
  batch_shading_color = "grey80", 
  outputPDF = FALSE,
  filename = here(".testing/HealthyAthletes/output/", paste0("P20036_HealthyAthletes_Baker2_Scatter_ALLspecies_CONC_CORR", Sys.Date(), "_V1.pdf")),
  cols_page = 4,
  rows_page = 3,
  point_size = 0.5,
  annot_scale = .65,
  paper_orientation  = "LANDSCAPE",
  point_transparency = 0.86, 
  page_no = NA,
  silent = TRUE, 
  return_plot_list = FALSE, base_size= 5) 

```

## Analytical Linearity

**Figure 3:** Raw signal intensity as a function of sample amount analysed by the mass spectrometer. Responses should be linear. **Passed, except some CE**

```{r, fig.height=4, fig.width=6, message=FALSE, warning=FALSE, dpi=300}
plot_responsecurves(
  data = mexp3,
  response_variable = "Intensity", 
  output_PDF = FALSE,
  pdf_file_name = here(".testing/output", paste0("HealthyAthletes/P20036_HealthyAthletes_Baker2_RQCs_", Sys.Date(), "_V1.pdf")),
  include_features_containing =  "CAR 18:1|PC 34:1|PC 38:4(b)|PI 38:3(a)|PC 38:6(b)|S1P d18:1$|CE 16:0|CE 20:4|^Cer d18:1/24:0|^Cer d18:1/16:0|LPC 16:1 (b)|PE 34:1|PS 38:4|TG 50:4 \\[-|!NA",
  exclude_features_containing = "",
  regr_max_percent = 200, 
  columns_page = 4,
  rows_page = 3,
  point_size = 1.0,
  line_width = 0.5,
  text_scale_factor = 0.5,base_size = 6,
  return_plot_list = TRUE
)$plt[[1]]
```

# EXPLORATORY DATA ANALYSIS

## Statistical Comparison of Groups (M vs F)

**Figure 4:** Statistical comparison between the experimental groups ***M*** and ***F*** using Welch's **t**-test. Lipid species with significant differences between *F* and *M* are highlighted in red (*P* \< 0.05 and \|FC\| \> 1.2).

```{r volcano}
d_annot <- readRDS(file = here(".testing/HealthyAthletes/data/BakePanel2_Data_Annotated_Long.rds")) |> filter (TIMEPOINT_ID == "T08") |> 
  rename(Concentration = Conc, FEATURE_NAME = Compound) #> 
  #group_by(FEATURE_NAME, SUBJECT_ID, GENDER) |> 
  #summarise(Concentration = median(Concentration)) |> ungroup()

d_annot$HEMOLYSIS <- factor(d_annot$HEMOLYSIS)

d_stats1 <- get_stats(d_annot, feature = "FEATURE_NAME", grouping = "HEMOLYSIS", group_case = "TRUE", group_ref = "FALSE", paired = FALSE, log_transform = TRUE) 
p_volcano1 <- volcano_plot(d_FC = d_stats1, p_adjust = FALSE, sig_FC_min = 1.2, sig_p_value_min = 0.05, symmetric_x = TRUE, point_size = 1.5, point_transparency = 0.6, scale_factor = 1.3, scale_factor_species_label = 1, axistick = 1)
p_volcano1



```

## Significanlty different lipid species

**Figure 5** Lipid species with statistically significant (*P* \> 0.5, \|FC\| \> 1.3) differences between M and F.

```{r dot, fig.height=4, fig.width=6,  message=FALSE, warning=FALSE, dpi=300}
#devtools::load_all()


d_sign <- d_stats1 |> filter(p_value < 0.05, abs(log2FC) > log2(1.2)) |> select(FEATURE_NAME)

d_long_sign <- d_annot |> inner_join(d_sign) |> rowwise() |>  mutate(SAMPLE_ID = SUBJECT_ID)

d_long_sign$ANALYSIS_ID <- d_long_sign$SUBJECT_ID

d_metadata <- d_annot |> select(SAMPLE_ID = SUBJECT_ID, GENDER) |> distinct()



pp <- plot_dotboxplus(data = d_long_sign, d_metadata = d_metadata, inner_group = HEMOLYSIS, outer_group = Exp, 
                contrasts = list(c("TRUE", "FALSE")), inner_group_colors = c("TRUE"="red", "FALSE" = "cyan4"), 
                rows_page = 3, columns_page = 6, class_per_page = FALSE, save_pdf = FALSE, filename = "dotplots2sigf.pdf", paired = FALSE, scale_text =.7, scale_signf = 2.5) 
pp[[1]] + ggtitle(label = NULL)
```

# Thank You :-)

---
title: "WaiKin Nof"
output: html_notebook
---

```{r setup}
#library(midar)
devtools::load_all()
library(here)
library(tidyverse)
```

## Proccess

```{r}
mexp <- MidarExperiment()
mexp <- read_MRMkit_results(mexp, raw_area_file = here(".testing/Rachel/OHCA/data/OHCA_FFP_quant_raw.csv"), final_results_file = "")
mexp <- loadMSOrganizerXLM(data = mexp, filename = here(".testing/Rachel/OHCA/data/MSTemplate_Creator_FFP_OHCA_BB.xlsm"))

mexp <- normalize_by_istd(mexp)
mexp <- quantitate_by_istd(mexp)
mexp <- calculate_qc_metrics(mexp)

mexp_final <- mexp
# # Drift correction WITHIN batch
# mexp_final<- drift_corr_loess(
#   data = mexp,
#   qc_types = c("TQC"),
#   smooth_by_batch = TRUE, loess_span = 0.75, apply_only_if_smpl_cv_lower = FALSE, treshold_smpl_cv_delta = 0)
# 
# # BETWEEN-batch median centering (applies to all species only currently)
# mexp_final <- batch_corr_center(data = mexp_final, qc_types = c("TQC"), center_by_fun = "median")


mexp_final <- apply_qc_filter(
  data = mexp_final,
  CV_BQC_max = 25,
  Intensity_BQC_min = 100,
  SB_RATIO_min = 3,
  R2_min = 0.8,
  RQC_CURVE = 1)

writeReportXLS(data = mexp_final, filename = here(".testing/Rachel/OHCA/output/Rachel_OHCA_MiQARreport.xlsx"))
```

# Plots

```{r}
# Raw areas
midar::plot_runscatter(
  data = mexp_final, y_var = "Intensity", transition_filter = "",show_driftcorrection = FALSE,QC_TYPE_fit = "BQC",
  show_batches = FALSE, batches_as_shades = FALSE, after_correction = FALSE, 
  cap_values = TRUE,cap_SPL_SD = 3, cap_QC_SD = 3,cap_top_n = 1,
  cols_page = 5, rows_page = 4,point_size = 1.5,point_transparency = 0.8,point_stroke_width = 1,
  annot_scale = 0.8, batch_line_color = "grey40",
  outputPDF = TRUE, filename = here(".testing/Rachel/OHCA/output/Rachel_OHCA_MiQARrunscatter_rawarea.pdf"), return_plot_list = FALSE)

# Concentrations
midar::plot_runscatter(
  data = mexp_final, y_var = "Concentration", transition_filter = "IS",filter_exclude = TRUE, show_driftcorrection = FALSE,QC_TYPE_fit = "TQC",
  show_batches = TRUE, batches_as_shades = FALSE, after_correction = FALSE, 
  cap_values = TRUE,cap_SPL_SD = 3, cap_QC_SD = 3,cap_top_n = 1,
  cols_page = 5, rows_page = 4,point_size = 1.5,point_transparency = 0.8,point_stroke_width = 1,
  annot_scale = 0.8, batch_line_color = "grey40",
  outputPDF = TRUE, filename = here(".testing/Rachel/OHCA/output/Rachel_OHCA_MiQARrunscatter_conc.pdf"), return_plot_list = FALSE)

midar::plot_responsecurves(
  data = mexp_final, 
  output_PDF = TRUE,
  pdf_file_name = here(".testing/Rachel/OHCA/output/Rachel_OHCA_MiQARresponse.pdf"),
  response_variable = "Intensity", 
  regr_max_percent = 200, 
  include_features_containing = "", 
  exclude_features_containing = "")
```


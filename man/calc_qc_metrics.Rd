% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/qc-filtering.R
\name{calc_qc_metrics}
\alias{calc_qc_metrics}
\title{Calculate Quality Control (QC) Metrics for Features}
\usage{
calc_qc_metrics(
  data = NULL,
  use_batch_medians = FALSE,
  include_norm_intensity_stats = NA,
  include_conc_stats = NA,
  include_response_stats = NA,
  include_calibration_results = NA
)
}
\arguments{
\item{data}{A \code{MidarExperiment} object containing data and metadata, whereby
data needs to be normalized and quantitated for specific QC metrics, such as
statistics based on normalized intensities and concentrations.}

\item{use_batch_medians}{Logical, whether to compute QC metrics using the
median of batch-wise derived values instead of the full dataset. Default is
FALSE.}

\item{include_norm_intensity_stats}{Logical. If \code{NA} (default), statistics on
normalized intensity values are included if the data is available. If \code{TRUE},
they are always calculated, raising an error if data is missing.}

\item{include_conc_stats}{Logical. If \code{NA} (default), concentration-related
statistics are included if concentration data is available. If \code{TRUE},
they are always calculated, raising an error if data is missing.}

\item{include_response_stats}{Logical. If \code{NA} (default), response curve statistics
are included if the required data is available. If \code{TRUE}, they are always
calculated, raising an error if data is missing.}

\item{include_calibration_results}{Logical, whether to incorporate external
calibration results into the QC metrics table if available. Default is TRUE.}
}
\value{
A \code{MidarExperiment} object with an updated \code{metrics_qc} table
containing computed QC metrics for each feature.
}
\description{
Computes various quality control (QC) metrics for each feature in a
\code{MidarExperiment} object. Metrics are derived from different sample
types and can be computed either across the full dataset or as medians
of batch-wise calculations.
}
\details{
\strong{Batch-wise calculations}:
The function computes the following QC metrics for each feature and for
different QC sample types (e.g., SPL, TQC, BQC, PBLK, NIST, LTR)

The format for the metrics is standardized as \code{metric_name_qc_type}, where
\code{qc_type} refers to the specific QC sample type for which the metric is
calculated. For example: \code{intensity_min_spl} refers to the minimum intensity
Statistics of normalized intensities , external calibration, and response
curves can be included by setting the relevant arguments
(\code{include_norm_intensity_stats}, \code{include_conc_stats},
\code{include_response_stats}, \code{include_calibration_results}) to \code{TRUE}.

\strong{Note} when corresponding underlying processed data is not available,
the function will not raise an error but will return \code{NA} values for the
respective metrics. This, however, does not apply for the optinal metrics
mentioned above. For these cases an error will be raised if the underlying
data is missing.

If \code{use_batch_medians = TRUE}, batch-specific QC statistics are computed
first, and then the median of these values is returned for each feature.
However, response curve and calibration statistics are calculated per
curve, irrespective of batches and \code{use_batch_medians} settings.

The calculated metrics are stored in the \code{metrics_qc} table of the
\code{MidarExperiment} objects and comprises following details
\itemize{
\item \strong{Feature details}:
Specific feature information extracted from the feature metadata tanle,
such as feature class, associated ISTD, quantifier status.
\item \strong{Feature MS Method Information} (if method variables are available in the analysis data).
Extracts and summarizes method-related variables for each feature. If multiple
values exist for the same feature, these will be concatenated into a string.
The latter would indicate inconsistent analysis conditions.
\itemize{
\item \code{precursor_mz}: The m/z value of the precursor ion(s),
\item \code{product_mz}: The m/z value of the product ion(s), concatenated if multiple values exist for the same feature.
\item \code{collision_energy}: The collision energy used for fragmentation, concatenated if multiple values exist exist for the same feature.
}
\item \strong{Missing Value Metrics}:
\itemize{
\item \code{missing_intensity_prop_spl}: Proportion of missing intensities for the SPL sample type.
\item \code{missing_norm_intensity_prop_spl}: Proportion of missing normalized intensities for SPL samples.
\item \code{missing_conc_prop_spl}: Proportion of missing concentration values for SPL samples.
\item \code{na_in_all}: Indicator if a feature has all missing intensities across all samples
}
\item \strong{Retention Time (RT) Metrics}: Requires that retention tim data are available.
\itemize{
\item \verb{rt_min_*}: Minimum retention time across different QC sample types (e.g., SPL, BQC, TQC).
\item \verb{rt_max_*}: Maximum retention time across different QC sample types.
\item \verb{rt_median_*}: Median retention time for specific QC sample types like PBLK, SPL, BQC, TQC, etc.
}
\item \strong{Intensity Metrics}:
\itemize{
\item \verb{intensity_min_*}: Minimum intensity value for features across different QC sample types such as SPL, TQC, BQC, etc.
\item \verb{intensity_max_*}: Maximum intensity values across sample types.
\item \verb{intensity_median_*}: Median intensity for various QC sample types.
\item \verb{intensity_cv_*}: Coefficient of variation (CV) of intensity values for specific QC types.
\item \verb{sb_ratio_*}: Signal-to-blank ratios such as the ratio of intensity values for SPL vs PBLK, UBLK, or SBLK.
\item \verb{intensity_q10_*}: The 10th percentile of intensity values for the SPL sample type.
}
\item \strong{Normalized Intensity Metrics} (only if \code{include_norm_intensity_stats = TRUE}):
Requires that raw intensities  were normalized, see \code{\link[=normalized_by_istd]{normalized_by_istd()}}
for details.
\itemize{
\item \verb{norm_intensity_cv_*}: Coefficient of variation (CV) of normalized intensities for QC sample types like TQC, BQC, SPL, etc.
}
\item \strong{Concentration Metrics} (only if \code{include_conc_stats = TRUE}):
Requires that concentration were calculated, see \code{\link[=quantify_by_istd]{quantify_by_istd()}} or
\code{\link[=quantify_by_calibration]{quantify_by_calibration()}} for details.
\itemize{
\item \verb{conc_median_*}: Median concentration values for different QC sample types like TQC, BQC, SPL, NIST, and LTR.
\item \verb{conc_cv_*}: Coefficient of variation (CV) for concentration values.
\item \verb{conc_dratio_sd_*}: The ratio of standard deviations of concentration between BQC or TQC and SPL samples.
\item \verb{conc_dratio_mad_*}: The ratio of median absolute deviations (MAD) between BQC or TQC and SPL concentrations.
}
\item \strong{Response Curve Metrics} (if \code{include_response_stats = TRUE}):
Calculates response curve statistics for each feature and each curve
(where \verb{#} refers to the curve identifier). Requires that response curves
are defined in the data. See \code{\link[=get_response_curve_stats]{get_response_curve_stats()}} for additional details.
\itemize{
\item \code{r2_rqc_#}: R-squared value of the linear regression for the response
curve, representing the goodness of fit.
\item \code{slopenorm_rqc_#}: Normalized slope of the linear regression for the
response curve, indicating the relationship between the response and
concentration.
\item \code{y0norm_rqc_#}: Normalized intercept of the linear regression for the
response curve, representing the baseline or starting value.
}
\item \strong{External Calibration Results} Incorporates external calibration results,
if \code{include_calibration_results = TRUE} and calibration curves are defined
in the data:
\itemize{
\item \code{fit_model}: The regression model used for curve fitting.
\item \code{weighting}: The weighting method applied during curve fitting.
\item \code{lowest_cal}: The lowest nonzero calibration concentration.
\item \code{r.squared}: R-squared value indicating the goodness of fit.
\item \code{coef_a}:
\itemize{
\item For \strong{linear fits}, this represents the slope of the regression line.
\item For \strong{quadratic fits}, this represents the coefficient of the quadratic term (\verb{xÂ²}).
}
\item \code{coef_b}:
\itemize{
\item For \strong{linear fits}, this represents the intercept of the regression line.
\item For \strong{quadratic fits}, this represents the coefficient of the linear term (\code{x}).
}
\item \code{coef_c}:
\itemize{
\item Only present for \strong{quadratic fits}, representing the intercept of the regression equation.
\item Set to \code{NA} for linear fits.
}
\item \code{sigma}: The residual standard error of the regression model.
\item \code{reg_failed}: Boolean flag indicating if regression fitting failed.
}
}
}

<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Drift and Batch Correction • midar</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Drift and Batch Correction">
<meta name="description" content="MiDAR: postprocessing and quality control of small molecule mass spectrometry data
">
<meta property="og:description" content="MiDAR: postprocessing and quality control of small molecule mass spectrometry data
">
<meta property="og:image" content="https://slinghub.github.io/midar/logo.svg">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">midar</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/00_get_started.html">Getting started</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-tutorials-recipes" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Tutorials &amp; Recipes</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-tutorials-recipes">
<li><h6 class="dropdown-header" data-toc-skip>Tutorials</h6></li>
    <li><a class="dropdown-item" href="../articles/T01_targetlipidomics_workflow.html">Lipidomics data processing (full workflow)</a></li>
    <li><a class="dropdown-item" href="../articles/T01_prepdata.html">Preparing and importing data</a></li>
    <li><a class="dropdown-item" href="../articles/T02_settingup_workflow.html">Basic MiDAR workflow</a></li>
    <li><a class="dropdown-item" href="../articles/T_DriftCorrect.html">Drift correction</a></li>
    <li><a class="dropdown-item" href="../articles/T_BatchCorrect.html">Batch correction</a></li>
    <li><a class="dropdown-item" href="../articles/T_CalibRef.html">Calibration by a reference sample</a></li>
    <li><a class="dropdown-item" href="../articles/R01_quantms.html">External calibration and QC</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Recipes</h6></li>
  </ul>
</li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-manual" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Manual</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-manual">
<li><h6 class="dropdown-header" data-toc-skip>Key concepts</h6></li>
    <li><a class="dropdown-item" href="../articles/01_datastructure.html">Data structures</a></li>
    <li><a class="dropdown-item" href="../articles/02_keydataids.html">Data indentifier</a></li>
    <li><a class="dropdown-item" href="../articles/02b_keyfeaturevar.html">Feature variables</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Data and metadata</h6></li>
    <li><a class="dropdown-item" href="../articles/03_midarexperiment.html">MidarExperiment Object</a></li>
    <li><a class="dropdown-item" href="../articles/04_dataimport.html">Data import</a></li>
    <li><a class="dropdown-item" href="../articles/05_metadataimport.html">Metadata import</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/07_driftbatchcorr.html">Batch/drift correction</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/SLINGhub/midar/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Drift and Batch Correction</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/SLINGhub/midar/blob/HEAD/vignettes/articles/07_driftbatchcorr.Rmd" class="external-link"><code>vignettes/articles/07_driftbatchcorr.Rmd</code></a></small>
      <div class="d-none name"><code>07_driftbatchcorr.Rmd</code></div>
    </div>

    
    
<p><code>MiDAR</code> provides functions for run-order drift and batch
correction. The correction is based on user-selected reference sample
types (<code>qc_types</code>), based on which all other samples are
adjusted. The corrections can be applied to <code>intensity</code>,
<code>norm_intensity</code>, or <code>conc</code> data.</p>
<div class="section level2">
<h2 id="drift-correction-smoothing">Drift correction (smoothing)<a class="anchor" aria-label="anchor" href="#drift-correction-smoothing"></a>
</h2>
<p>Following drift correction method are available in
<code>MiDAR</code>, two of which are typically used for QC samples and
one (gaussian kernel-based) for study samples.</p>
<p>Corrections can be applied on a batch-by-batch basis
(<code>batch_wise = TRUE</code>, default) or across all batches
(<code>batch_wise = FALSE</code>). The correction can either replace
existing drift or batch corrections
(<code>⁠replace_previous = ⁠TRUE⁠</code>, default) or applied on top of
existing corrections (`⁠replace_previous = FALSE’).</p>
<p>Drift correction can be applied to all features
(<code>conditional_correction = FALSE</code>) or conditionally, based on
whether the sample CV difference before and after correction is below a
defined threshold (<code>cv_diff_threshold)</code>. The conditional
correction is applied separately for each batch if
<code>batch_wise = TRUE</code>.</p>
<p>It is recommended to visually inspect the correction using the
<code><a href="../reference/plot_runscatter.html">plot_runscatter()</a></code> function. Set the argument
<code>recalc_trend_after = TRUE</code> so that the trends after
correction are also available for plotting. For further details, refer
to the description of <code><a href="../reference/plot_runscatter.html">plot_runscatter()</a></code>. This, however,
doubles the processing time.</p>
<p><strong>Note</strong>: The function outputs a message indicating the
median CV change and the mean absolute CV before and after correction
for all samples. However, these metrics are experimental and should not
be used as definitive criteria for correction (see function
documentation).</p>
<table style="width:93%;" class="table">
<colgroup>
<col width="12%">
<col width="30%">
<col width="50%">
</colgroup>
<thead><tr class="header">
<th>Method</th>
<th>MiDAR function</th>
<th>Details</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Cubic Spline</td>
<td><code>correct_dr  ift_cubicspline()</code></td>
<td>Cubic spline with smoothing parameter being either determined using
cross-validation or set as fixed across all features.<br>
Typically used with QC samples as references</td>
</tr>
<tr class="even">
<td>Loess</td>
<td>
<code>correct  _drift_loess()</code>.</td>
<td>Loess smoothing with span set as fixed value for all features.<br>
Typically used with QC samples as reference</td>
</tr>
<tr class="odd">
<td>Ga ussian Kernel</td>
<td><code>correct_drift  _gaussiankernel()</code></td>
<td>
<p>Gaussian kernel smoothing with fixed kernel size for all
features. Option to smooth the scale (variability) as well.</p>
<p>Typically used with study samples as reference. Only suitable for
large sample numbers that are well-randomized/stratified.</p>
</td>
</tr>
</tbody>
</table>
<p>The cubic spline smoothing approach, particularly when used with the
regularization parameter <code>lambda</code>, is similar but not
identical to previously described QC-based drift correction methods,
such as <strong>QC-RSC (Quality Control Regularized Spline
Correction)</strong>, described in <span class="citation">Dunn et al.
(2011)</span> and <span class="citation">Kirwan et al.
(2013)</span>.</p>
<p>See the tutorial <a href="articles/07_driftbatchcorr.html">Drift and
Batch Correction</a> for more information on how to use these functions
and plot the results.</p>
</div>
<div class="section level2">
<h2 id="batch-effect-correction-centering">Batch-effect correction (centering)<a class="anchor" aria-label="anchor" href="#batch-effect-correction-centering"></a>
</h2>
<p><code>MiDAR</code> currently supports median centering-based batch
correction <code>correct_batch_centering()\</code>, whereby the scale of
the batches can optioanally also be normalized. The selected QC types
(<code>ref_qc_types</code>) are used to calculate the medians, which are
then used to align all other samples.</p>
<p>See the tutorial <a href="articles/07_driftbatchcorr.html">Drift and
Batch Correction</a> for more information.</p>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-dunn2011ProceduresLargescaleMetabolic" class="csl-entry">
Dunn, Warwick B., David Broadhurst, Paul Begley, Eva Zelena, Sue
Francis-McIntyre, Nadine Anderson, Marie Brown, et al. 2011.
<span>“Procedures for Large-Scale Metabolic Profiling of Serum and
Plasma Using Gas Chromatography and Liquid Chromatography Coupled to
Mass Spectrometry.”</span> <em>Nature Protocols</em> 6 (7): 1060–83. <a href="https://doi.org/10.1038/nprot.2011.335" class="external-link">https://doi.org/10.1038/nprot.2011.335</a>.
</div>
<div id="ref-kirwan2013CharacterisingCorrectingBatch" class="csl-entry">
Kirwan, J. A., D. I. Broadhurst, R. L. Davidson, and M. R. Viant. 2013.
<span>“Characterising and Correcting Batch Variation in an Automated
Direct Infusion Mass Spectrometry (DIMS) Metabolomics Workflow.”</span>
<em>Analytical and Bioanalytical Chemistry</em> 405 (15): 5147–57. <a href="https://doi.org/10.1007/s00216-013-6856-7" class="external-link">https://doi.org/10.1007/s00216-013-6856-7</a>.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Bo Burla.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
